name: Push Release Candidate Tag

# This workflow pushes the release-candidate tag to the remote repository
# The tag should already exist locally before running this workflow

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name to push'
        required: true
        default: 'release-candidate'
      dry_run:
        description: 'Dry run (show what would be pushed without actually pushing)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  push-tag:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        with:
          ref: development
          fetch-depth: 0  # Full history needed to fetch tags
      
      - name: Configure git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: Fetch all tags
        run: |
          git fetch --tags
          echo "Available tags:"
          git tag -l
      
      - name: Verify tag exists
        env:
          TAG_NAME: ${{ github.event.inputs.tag_name }}
        run: |
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "‚ùå ERROR: Tag '$TAG_NAME' does not exist in the repository"
            echo ""
            echo "Available tags:"
            git tag -l
            echo ""
            echo "To create the tag, run from your local repository:"
            echo "  git fetch origin development"
            echo "  git tag -a $TAG_NAME development -F <annotation-file>"
            echo "  git push origin $TAG_NAME"
            exit 1
          fi
          
          echo "‚úì Tag '$TAG_NAME' exists"
          echo ""
          echo "Tag details:"
          git show "$TAG_NAME" --no-patch
      
      - name: Check if tag exists on remote
        env:
          TAG_NAME: ${{ github.event.inputs.tag_name }}
        run: |
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "‚ö†Ô∏è  WARNING: Tag '$TAG_NAME' already exists on remote"
            echo ""
            echo "Remote tag info:"
            git ls-remote --tags origin | grep "$TAG_NAME"
            echo ""
            echo "This workflow will attempt to push anyway (may fail if tag is identical)"
          else
            echo "‚úì Tag does not exist on remote (ready to push)"
          fi
      
      - name: Push tag (Dry Run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        env:
          TAG_NAME: ${{ github.event.inputs.tag_name }}
        run: |
          echo "üîç DRY RUN MODE - No changes will be made"
          echo ""
          echo "Would push tag: $TAG_NAME"
          echo "Tag points to commit:"
          git rev-parse "$TAG_NAME"
          echo ""
          echo "Command that would be executed:"
          echo "  git push origin $TAG_NAME"
      
      - name: Push tag (Real)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          TAG_NAME: ${{ github.event.inputs.tag_name }}
        run: |
          echo "üöÄ Pushing tag '$TAG_NAME' to remote..."
          git push origin "$TAG_NAME"
          
          echo ""
          echo "‚úÖ Tag pushed successfully!"
          echo ""
          echo "üìå View tag at:"
          echo "   https://github.com/${{ github.repository }}/releases/tag/$TAG_NAME"
          echo ""
          echo "üìù To create a GitHub release from this tag, visit:"
          echo "   https://github.com/${{ github.repository }}/releases/new?tag=$TAG_NAME"
      
      - name: Verify push
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          TAG_NAME: ${{ github.event.inputs.tag_name }}
        run: |
          echo "Verifying tag was pushed..."
          sleep 2  # Give GitHub a moment to update
          
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "‚úÖ Verification successful: Tag is now on remote"
            git ls-remote --tags origin | grep "$TAG_NAME"
          else
            echo "‚ùå Verification failed: Tag not found on remote"
            exit 1
          fi
