name: CI

on:
  push:
    branches: [main, development, copilot/**]
  pull_request:
    branches: [main, development]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  ubuntu:
    name: Ubuntu Latest - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install GLPK system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libglpk-dev glpk-utils
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-timeout
        env:
          CFLAGS: "-I/usr/include"
          LDFLAGS: "-L/usr/lib"
      
      - name: Install package in editable mode
        run: pip install --no-build-isolation --no-deps -e .
        env:
          CFLAGS: "-I/usr/include"
          LDFLAGS: "-L/usr/lib"
      
      - name: Run tests
        run: pytest -q tests/ --junit-xml=pytest-results.xml
      
      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-ubuntu-py${{ matrix.python-version }}
          path: |
            pytest-results.xml
            pytest.log
            core.*
          retention-days: 7
          if-no-files-found: ignore
  
  macos:
    name: macOS Latest - Python ${{ matrix.python-version }}
    runs-on: macos-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install GLPK via Homebrew
        run: |
          brew install glpk
          echo "GLPK installed at: $(brew --prefix glpk)"
          echo "Homebrew prefix: $(brew --prefix)"
      
      - name: Set build environment variables
        run: |
          echo "CFLAGS=-I$(brew --prefix)/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L$(brew --prefix)/lib" >> $GITHUB_ENV
      
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-timeout
      
      - name: Install package in editable mode
        run: pip install --no-build-isolation --no-deps -e .
      
      - name: Run tests
        run: |
          python -X faulthandler -m pytest -q tests/ --junit-xml=pytest-results.xml
      
      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-macos-py${{ matrix.python-version }}
          path: |
            pytest-results.xml
            pytest.log
            core.*
          retention-days: 7
          if-no-files-found: ignore
  
  windows:
    name: Windows Latest - Python ${{ matrix.python-version }}
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13', '3.14']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-glpk
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-python
            mingw-w64-x86_64-python-pip
            mingw-w64-x86_64-python-numpy
            mingw-w64-x86_64-python-scipy
            mingw-w64-x86_64-cython
      
      - name: Fix SSL certificates for pip
        shell: msys2 {0}
        run: |
          python -m pip install --upgrade pip setuptools wheel certifi
          export SSL_CERT_FILE=$(python -m certifi)
          echo "SSL_CERT_FILE=$SSL_CERT_FILE" >> $GITHUB_ENV
      
      - name: Install Python dependencies
        shell: msys2 {0}
        run: |
          pip install prettytable pytest pytest-timeout
      
      - name: Install package in editable mode
        shell: msys2 {0}
        run: |
          export CFLAGS="-I/mingw64/include"
          export LDFLAGS="-L/mingw64/lib"
          pip install --no-build-isolation --no-deps -e .
      
      - name: Run tests
        shell: msys2 {0}
        run: |
          export PATH="/mingw64/bin:$PATH"
          pytest -q tests/ --junit-xml=pytest-results.xml
      
      - name: Upload test results on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-windows-py${{ matrix.python-version }}
          path: |
            pytest-results.xml
            pytest.log
            core.*
          retention-days: 7
          if-no-files-found: ignore
  
  build-source:
    name: Build Source Distribution
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools Cython numpy
      
      - name: Build source distribution
        run: python -m build --sdist
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: source-distribution
          path: dist/*.tar.gz
          retention-days: 30
