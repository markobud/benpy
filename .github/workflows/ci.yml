name: CI

on:
  push:
    branches: [ main, development, copilot/** ]
  pull_request:
    branches: [ main, development ]
  workflow_dispatch:

# Default permissions for all jobs
permissions:
  contents: read

jobs:
  test:
    name: Test on ${{ matrix.os }} - Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        # Test on Ubuntu, macOS, and Windows
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.11']
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      # Install GLPK on Ubuntu
      - name: Install GLPK (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y glpk-utils libglpk-dev
          echo "CFLAGS=-I/usr/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L/usr/lib" >> $GITHUB_ENV
      
      # Install GLPK on macOS
      - name: Install GLPK (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install glpk
          GLPK_PREFIX=$(brew --prefix glpk)
          echo "CFLAGS=-I${GLPK_PREFIX}/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L${GLPK_PREFIX}/lib" >> $GITHUB_ENV
      
      # Install GLPK on Windows using MSYS2
      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-glpk
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-python-numpy
      
      - name: Set up GLPK paths (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "CFLAGS=-I/mingw64/include" >> $GITHUB_ENV
          echo "LDFLAGS=-L/mingw64/lib" >> $GITHUB_ENV
          echo "/mingw64/bin" >> $GITHUB_PATH
      
      # Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install wheel setuptools
          # Pin native dependencies to known-working versions to reduce ABI/extension mismatch risk
          pip install "Cython>=3.0.0,<4.0.0" "numpy>=1.24.0,<2.0.0" "scipy>=1.10.0,<2.0.0" prettytable
          pip install pytest pytest-cov
      
      # Build the extension
      - name: Build extension
        run: |
          python setup.py build_ext --inplace
      
      # Run tests (Unix)
      - name: Run tests (Unix)
        if: runner.os != 'Windows'
        run: |
          PYTHONPATH=$PWD/src:$PYTHONPATH pytest tests/ -v --cov=benpy --cov-report=xml --cov-report=term -k "not test_example03_no_vertex and not test_example04_totally_unbounded"
      
      # Run tests (Windows)
      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          PYTHONPATH=$PWD/src:$PYTHONPATH pytest tests/ -v --cov=benpy --cov-report=xml --cov-report=term -k "not test_example03_no_vertex and not test_example04_totally_unbounded"
      
      # Upload coverage to Codecov (optional)
      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # Build wheels for distribution
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
      - uses: actions/checkout@v4
      
      # Install GLPK for cibuildwheel
      - name: Install GLPK (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y glpk-utils libglpk-dev
      
      - name: Install GLPK (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install glpk
      
      # Setup MSYS2 for Windows wheel builds
      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-glpk
            mingw-w64-x86_64-gcc
      
      # Build wheels
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.16.5
        env:
          # Skip PyPy and musllinux builds for now
          # Use manylinux_2_28 (Alma Linux 8) instead of manylinux2014 (CentOS 7)
          CIBW_SKIP: "pp* *-musllinux_* *-manylinux_i686"
          # Build for Python 3.8-3.12 on manylinux_2_28 and macOS
          CIBW_BUILD: "cp38-* cp39-* cp310-* cp311-* cp312-*"
          CIBW_MANYLINUX_X86_64_IMAGE: manylinux_2_28
          CIBW_MANYLINUX_AARCH64_IMAGE: manylinux_2_28
          # Install GLPK in the build environment
          CIBW_BEFORE_ALL_LINUX: |
            if command -v apt-get >/dev/null; then
              apt-get update && apt-get install -y libglpk-dev
              if [ $? -ne 0 ]; then
                echo "apt-get install libglpk-dev failed" >&2
                exit 1
              fi
            elif command -v yum >/dev/null; then
              # Use dnf for newer RHEL-based systems (AlmaLinux 8+)
              if command -v dnf >/dev/null; then
                dnf install -y epel-release || echo "EPEL repository already installed or not needed" >&2
                dnf install -y glpk-devel || { echo "dnf install glpk-devel failed" >&2; exit 1; }
              else
                # Fallback to yum for older systems
                yum clean all
                yum -y install epel-release || echo "EPEL repository already installed or not needed" >&2
                yum -y install glpk-devel || { echo "yum install glpk-devel failed" >&2; exit 1; }
              fi
            else
              echo "No supported package manager found to install GLPK" >&2
              exit 1
            fi
          CIBW_BEFORE_ALL_MACOS: "brew install glpk || brew upgrade glpk"
          # Install GLPK on Windows using MSYS2
          # Note: GitHub Actions Windows runners have MSYS2 at C:\msys64 by default
          CIBW_BEFORE_ALL_WINDOWS: >-
            C:\\msys64\\usr\\bin\\bash -lc "pacman -S --noconfirm mingw-w64-x86_64-glpk"
          # Install build dependencies
          CIBW_BEFORE_BUILD: "pip install Cython numpy setuptools wheel"
          # Run tests after building
          CIBW_TEST_REQUIRES: "pytest numpy scipy prettytable"
          CIBW_TEST_COMMAND: "pytest {project}/tests/test_import.py -v"
          # Environment variables for finding GLPK
          CIBW_ENVIRONMENT_LINUX: "CFLAGS='-I/usr/include' LDFLAGS='-L/usr/lib -L/usr/lib64 -L/usr/lib/x86_64-linux-gnu'"
          CIBW_ENVIRONMENT_MACOS: "CFLAGS='-I/usr/local/include -I/opt/homebrew/include' LDFLAGS='-L/usr/local/lib -L/opt/homebrew/lib'"
          CIBW_ENVIRONMENT_WINDOWS: "CFLAGS='-I/mingw64/include' LDFLAGS='-L/mingw64/lib'"
      
      # Upload wheels as artifacts
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
          retention-days: 30


  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools Cython numpy
      
      - name: Build sdist
        run: python -m build --sdist
      
      - name: Upload sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 30
