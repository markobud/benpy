name: Publish to PyPI

# Workflow for publishing to production PyPI
# This workflow:
# 1. Manually triggered only (after testing with TestPyPI)
# 2. Builds the source distribution (sdist)
# 3. Optionally downloads wheels from a previous build-wheels workflow run
# 4. Publishes to production PyPI
#
# Note: For trusted publishing, configure it in PyPI project settings
# Otherwise, set the PYPI_API_TOKEN secret
# 
# For testing, use test_publish.yml which publishes to TestPyPI automatically on release

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "publish" to confirm PyPI publication'
        required: true
        default: ''

permissions:
  contents: read
  id-token: write  # Required for trusted publishing

jobs:
  verify_release:
    name: Verify release conditions
    runs-on: ubuntu-latest
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
    
    steps:
      - name: Check release conditions
        id: check
        run: |
          if [[ "${{ github.event.inputs.confirm }}" != "publish" ]]; then
            echo "Manual trigger requires 'publish' confirmation"
            exit 1
          fi
          echo "should_publish=true" >> $GITHUB_OUTPUT
  
  build_artifacts:
    name: Build all artifacts
    needs: [verify_release]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y libglpk-dev glpk-utils
      
      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build wheel setuptools Cython numpy
      
      - name: Build source distribution
        run: python -m build --sdist
      
      - name: Upload source distribution
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          retention-days: 90
  
  download_artifacts:
    name: Download build artifacts
    needs: [build_artifacts]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download wheels (if available)
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true
        continue-on-error: true  # Wheels may not exist in this run
      
      - name: Download source distribution
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist
      
      - name: List artifacts
        run: |
          ls -lh dist/ || echo "No artifacts found"
          if [ -d "dist" ]; then
            echo "Total artifacts: $(ls dist/ | wc -l)"
          else
            echo "No dist directory found"
            exit 1
          fi
      
      - name: Upload combined artifacts
        uses: actions/upload-artifact@v4
        with:
          name: all-dist-artifacts
          path: dist/*
          retention-days: 90
  
  publish_pypi:
    name: Publish to PyPI
    needs: [download_artifacts]
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/benpy
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          name: all-dist-artifacts
          path: dist
      
      - name: Verify artifacts
        run: |
          echo "Verifying artifacts before publication..."
          ls -lh dist/
          
          # Check we have source distribution
          if ! ls dist/*.tar.gz >/dev/null 2>&1; then
            echo "ERROR: No source distribution found"
            exit 1
          fi
          
          # Check for wheels (optional)
          if ! ls dist/*.whl >/dev/null 2>&1; then
            echo "WARNING: No wheels found, publishing source only"
          fi
          
          echo "Artifacts verified, ready for publication"
      
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true
          # Using trusted publishing (no token needed if configured in PyPI)
          # If trusted publishing is not configured, add:
          # password: ${{ secrets.PYPI_API_TOKEN }}
  
  verify_publication:
    name: Verify PyPI publication
    needs: [publish_pypi]
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for PyPI to update
        run: sleep 60
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Verify installation from PyPI
        run: |
          pip install --index-url https://pypi.org/simple/ --no-cache-dir benpy
          python -c "import benpy; print('Successfully installed from PyPI')"
