name: Build Wheels

on:
  push:
    branches: [main, development]
    tags:
      - 'v*'
  pull_request:
    branches: [main, development]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Temporarily disabled: ubuntu-latest, macos-13, windows-latest, macos-14
        # All wheel builds disabled - will be re-enabled after fixing platform-specific issues
        os: []
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up QEMU (for Linux ARM builds)
        if: runner.os == 'Linux'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64
      
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_BUILD_VERBOSITY: 1
          MACOSX_DEPLOYMENT_TARGET: "13.0"
      
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: ./wheelhouse/*.whl
          retention-days: 30
  
  # Temporarily disabled to reduce CI time during macos-14 debugging
  # build_sdist:
  #   name: Build source distribution
  #   runs-on: ubuntu-latest
  #   
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     
  #     - name: Setup Python
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: '3.11'
  #     
  #     - name: Install build dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install build wheel setuptools Cython numpy
  #     
  #     - name: Build source distribution
  #       run: python -m build --sdist
  #     
  #     - name: Upload source distribution
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: sdist
  #         path: dist/*.tar.gz
  #         retention-days: 30
  
  # Temporarily disabled - no wheels being built
  # verify_wheels:
  #   name: Verify wheels on ${{ matrix.os }}
  #   needs: [build_wheels]
  #   runs-on: ${{ matrix.os }}
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       # Temporarily disabled: ubuntu-latest, windows-latest
  #       # Only testing macos-latest to match build_wheels configuration
  #       os: [macos-latest]
  #       python-version: ['3.9', '3.10', '3.11', '3.12']
  #   
  #   steps:
  #     - name: Checkout code (for tests)
  #       uses: actions/checkout@v4
  #     
  #     - name: Setup Python ${{ matrix.python-version }}
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: ${{ matrix.python-version }}
  #     
  #     - name: Download wheels
  #       uses: actions/download-artifact@v4
  #       with:
  #         pattern: wheels-*
  #         path: wheelhouse
  #         merge-multiple: true
  #     
  #     - name: Install GLPK (Ubuntu)
  #       if: runner.os == 'Linux'
  #       run: |
  #         sudo apt-get update -qq
  #         sudo apt-get install -y libglpk-dev glpk-utils
  #     
  #     - name: Install GLPK (macOS)
  #       if: runner.os == 'macOS'
  #       run: |
  #         set -e
  #         # Get Homebrew prefix (may be /opt/homebrew for arm64 or /usr/local for x86_64)
  #         BREW_PREFIX="$(brew --prefix || true)"
  #         echo "Homebrew prefix: $BREW_PREFIX"
  #         
  #         # Install GLPK
  #         brew install glpk
  #         
  #         # Set library path for dyld at test time
  #         echo "DYLD_FALLBACK_LIBRARY_PATH=${BREW_PREFIX}/lib:${DYLD_FALLBACK_LIBRARY_PATH:-}" >> $GITHUB_ENV
  #         
  #         # Debug: list installed GLPK libraries
  #         ls -la "${BREW_PREFIX}/lib" | grep glpk || true
  #     
  #     - name: Install GLPK (Windows)
  #       if: runner.os == 'Windows'
  #       uses: msys2/setup-msys2@v2
  #       with:
  #         msystem: MINGW64
  #         update: true
  #         install: mingw-w64-x86_64-glpk
  #     
  #     - name: Find and install wheel
  #       shell: bash
  #       run: |
  #         # Find the wheel for current platform and Python version
  #         PYTHON_VER=$(python -c "import sys; print(f'{sys.version_info.major}{sys.version_info.minor}')")
  #         echo "Looking for wheel for Python ${PYTHON_VER}"
  #         
  #         # List available wheels
  #         ls -la wheelhouse/
  #         
  #         # Install matching wheel
  #         pip install wheelhouse/benpy-*-cp${PYTHON_VER}-*.whl || {
  #           echo "No matching wheel found for Python ${PYTHON_VER}"
  #           exit 0
  #         }
  #     
  #     - name: Test wheel installation
  #       shell: bash
  #       run: |
  #         # Display DYLD path for debugging on macOS
  #         if [[ "$RUNNER_OS" == "macOS" ]]; then
  #           echo "DYLD_FALLBACK_LIBRARY_PATH=$DYLD_FALLBACK_LIBRARY_PATH"
  #         fi
  #         
  #         # Try to import benpy with diagnostic output
  #         python - <<'PY'
  #         import sys
  #         import traceback
  #         
  #         try:
  #             import benpy
  #             print('✓ benpy imported successfully')
  #             print(f'benpy version: {benpy.__version__ if hasattr(benpy, "__version__") else "unknown"}')
  #             
  #             # On macOS, show what libraries the extension is linked against
  #             if sys.platform == 'darwin':
  #                 import importlib
  #                 import subprocess
  #                 import os
  #                 m = importlib.import_module('benpy')
  #                 if hasattr(m, '__file__'):
  #                     so_path = m.__file__
  #                     print(f'\nbenpy extension path: {so_path}')
  #                     if so_path and (so_path.endswith('.so') or so_path.endswith('.dylib')):
  #                         print('\notool -L output:')
  #                         try:
  #                             subprocess.run(['otool', '-L', so_path], check=True)
  #                         except Exception as e:
  #                             print(f'  Could not run otool: {e}')
  #         except Exception as e:
  #             print('✗ Failed to import benpy')
  #             traceback.print_exc()
  #             sys.exit(1)
  #         PY
  #         
  #         # Run basic import test
  #         pip install pytest numpy scipy prettytable
  #         pytest tests/test_import.py -v || echo "Tests not available or failed"
